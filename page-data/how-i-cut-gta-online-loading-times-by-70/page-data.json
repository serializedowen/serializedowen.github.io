{"componentChunkName":"component---src-templates-post-js","path":"/how-i-cut-gta-online-loading-times-by-70","result":{"data":{"markdownRemark":{"html":"<p><a href=\"https://nee.lv/2021/02/28/How-I-cut-GTA-Online-loading-times-by-70/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">原文链接</a></p>\n<p>GTA Online. Infamous for its slow loading times. Having picked up the game again to finish some of the newer heists I was shocked (/s) to discover that it still loads just as slow as the day it was released 7 years ago.</p>\n<p>It was time. Time to get to the bottom of this.</p>\n<h2 id=\"recon\" style=\"position:relative;\"><a href=\"#recon\" aria-label=\"recon permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recon</h2>\n<p>First I wanted to check if someone had already solved this problem. Most of the results I found pointed towards anecdata about how the game is so sophisticated that it needs to load so long, stories on how the p2p network architecture is rubbish (not saying that it isn’t), some elaborate ways of loading into story mode and a solo session after that and a couple of mods that allowed skipping the startup R* logo video. Some more reading told me we could save a whopping 10-30 seconds with these combined!</p>\n<p>Meanwhile on my PC…</p>\n<h2 id=\"benchmark\" style=\"position:relative;\"><a href=\"#benchmark\" aria-label=\"benchmark permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Benchmark</h2>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">2\n3\n4\n5\n6\n7\n8\nStory mode load time:  ~1m 10s\nOnline mode load time: ~6m flat\nStartup menu disabled, time from R* logo until in-game (social club login time isn&#39;t counted).\n\nOld but decent CPU:   AMD FX-8350\nCheap-o SSD:          KINGSTON SA400S37120G\nWe have to have RAM:  2x Kingston 8192 MB (DDR3-1337) 99U5471\nGood-ish GPU:         NVIDIA GeForce GTX 1070</code></pre></div>\n<p>I know my setup is dated but what on earth could take 6x longer to load into online mode? I couldn’t measure any difference using the story-to-online loading technique as others have found before me. Even if it did work the results would be down in the noise.</p>\n<h2 id=\"i-am-not-alone\" style=\"position:relative;\"><a href=\"#i-am-not-alone\" aria-label=\"i am not alone permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>I am (Not) Alone</h2>\n<p>If this poll is to be trusted then the issue is widespread enough to mildly annoy more than 80% of the player base. It’s been 7 years R*!\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0b1b44b1a68a85488b2ea050ccb0b18e/87a80/0.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 41.891891891891895%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABXklEQVQoz12Ri2rCQBBF8/8fVAqFQqFQS0FbpdYHjVpttRoTY7J5mDink6yP0MBlJpvs2XtnHck8JHaRMkEAOR5tTVNktUImE6TVQt77SLuDfAyu/VsXGQyR0RjpvCKuiyOHkGMFLSKFlSdYZn/Mctsbg+TaR7Gtma4liVX1Xn3f72sTTmFWpMGUPJyyXY6J4j2EPrLzFV2qjhDHEAR6kh5nEtDNtRSIwur1yojKKbxnzOyGw/KeaHZL9n0H/iMSPiH+g46jp040/nCEjDXabGYjV9GrNe3xA5tMwU4Zf5EHA4rdCLPukZuFbuzCUGe0csHt16cThuB5/H/kXBVWAw+JRxx6mChg87vAC7YU2x1M58hLGwZjG+lnCTqj0+6LpFGtw3RNlsZk+UFHkpJoLSsnKvF1jtkJojd4gTWgcp7fFeiRp3tSvblAAaZyMdfYm1M8vVk+Xaumu0bUJvAP0ABoXmyq5iwAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"0\"\n        title=\"0\"\n        src=\"/static/0b1b44b1a68a85488b2ea050ccb0b18e/fcda8/0.png\"\n        srcset=\"/static/0b1b44b1a68a85488b2ea050ccb0b18e/12f09/0.png 148w,\n/static/0b1b44b1a68a85488b2ea050ccb0b18e/e4a3f/0.png 295w,\n/static/0b1b44b1a68a85488b2ea050ccb0b18e/fcda8/0.png 590w,\n/static/0b1b44b1a68a85488b2ea050ccb0b18e/efc66/0.png 885w,\n/static/0b1b44b1a68a85488b2ea050ccb0b18e/87a80/0.png 973w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\nLooking around a bit to find who are the lucky ~20% that get sub 3 minute load times I came across a few benchmarks with high-end gaming PCs and an online mode load time of about 2 minutes. I would kill hack for a 2 minute load time! It does seem to be hardware-dependent but something doesn’t add up here…</p>\n<p>How come their story mode still takes near a minute to load? (The M.2 one didn’t count the startup logos btw.) Also, loading story to online takes them only a minute more while I’m getting about five more. I know that their hardware specs are a lot better but surely not 5x better.</p>\n<h2 id=\"highly-accurate-measurements\" style=\"position:relative;\"><a href=\"#highly-accurate-measurements\" aria-label=\"highly accurate measurements permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Highly accurate measurements</h2>\n<p>Armed with such powerful tools as the Task Manager I began to investigate what resources could be the bottleneck.\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9c57dd56498e47cbcf5e6284b2d2715c/844cc/1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 55.4054054054054%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAACEUlEQVQoz2VSi27UMBC8//8lKAKBEIiWdznaXo/2HnldYiex48TPYRIoqGBpZCfrnZ0d76ooS5RFgaHrkIyBtxbOe1gfCA8XIwKAkBICY/FwQFh/RxiGX/9CWO5H3juWNVbZ/R7i/APkHXei3tyhub6FWK9RE3q3A4i03SIJgXR1BZAUzuFhJRLPq2xarLa5wjof8GQt8Hrv8OaYsJHAqSqRzYlUkkicZLskzTTNoCH7Hk3TQBCtlOjaFllRYSWKFrUYsTlUONYKwkQMLmEaDIwZ4WeSrocjoWv7Bbbt4ISEdbSGcUuBTEF5YstjzYAa0EkB1XfUH2mYR/j4CfHiPeL5BWLDVn/cIT09Q3r5Cun5C6SzZ4hfviLebBCvb4D9AVVRklC3MCOVUfZs7OxGVAr+7TvEb+slKd3vMFGZyQp4JgYmhrxApLeRMc9vbyZU1axw/Rl2u0F3eYlwu2WlPRIvupiW150LeLYupMZpDBCEnP6itfHPvs/pod5dsfoJxyxDT6OX9+IoefrjQ0Sc/VGa5vdojYPU0yOIGWpCx0L3xxwrQ8MHrZHlOQxfdJwmtpMvhmvr0dvAGVWQgpgJB4v2N+QDtEVPlTtashq0wchESQ8NB3se5kTCnsm1shwRh6aSJOwheF4UkeAxJrSLQhL6EPDf4gAr0VGRpcoA3WkoZaB4VqOHmv7B6GB8wj7L8ROZiUhvRH9xEAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"1\"\n        title=\"1\"\n        src=\"/static/9c57dd56498e47cbcf5e6284b2d2715c/fcda8/1.png\"\n        srcset=\"/static/9c57dd56498e47cbcf5e6284b2d2715c/12f09/1.png 148w,\n/static/9c57dd56498e47cbcf5e6284b2d2715c/e4a3f/1.png 295w,\n/static/9c57dd56498e47cbcf5e6284b2d2715c/fcda8/1.png 590w,\n/static/9c57dd56498e47cbcf5e6284b2d2715c/efc66/1.png 885w,\n/static/9c57dd56498e47cbcf5e6284b2d2715c/c83ae/1.png 1180w,\n/static/9c57dd56498e47cbcf5e6284b2d2715c/844cc/1.png 1306w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\nAfter taking a minute to load the common resources used for both story and online modes (which is near on par with high-end PCs) GTA decides to max out a single core on my machine for four minutes and do nothing else.</p>\n<p>Disk usage? None! Network usage? There’s a bit, but it drops basically to zero after a few seconds (apart from loading the rotating info banners). GPU usage? Zero. Memory usage? Completely flat…</p>\n<p>What, is it mining crypto or something? I smell code. Really bad code.</p>\n<h2 id=\"single-thread-bound\" style=\"position:relative;\"><a href=\"#single-thread-bound\" aria-label=\"single thread bound permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Single thread-bound</h2>\n<p>While my old AMD CPU has 8 cores and it does pack a punch, it was made in the olden days. Back when AMD’s single-thread performance was way behind Intel’s. This might not explain all of the load time differences but it should explain most of it.</p>\n<p>What’s odd is that it’s using up just the CPU. I was expecting vast amounts of disk reads loading up resources or loads of network requests trying to negotiate a session in the p2p network. But this? This is probably a bug.</p>\n<h2 id=\"profiling\" style=\"position:relative;\"><a href=\"#profiling\" aria-label=\"profiling permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Profiling</h2>\n<p>Profilers are a great way of finding CPU bottlenecks. There’s only one problem - most of them rely on instrumenting the source code to get a perfect picture of what’s happening in the process. And I don’t have the source code. Nor do I need microsecond-perfect readings - I have 4 minutes’ worth of a bottleneck.</p>\n<p>Enter stack sampling: for closed source applications there’s only one option. Dump the running process’ stack and current instruction pointer’s location to build a calling tree in set intervals. Then add them up to get statistics on what’s going on. There’s only one profiler that I know of (might be ignorant here) that can do this on Windows. And it hasn’t been updated in over 10 years. It’s Luke Stackwalker! Someone, please give this project some love :)\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0d81e2a29caeaef1d92ba1009cadad88/09e48/2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 46.621621621621614%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB2UlEQVQoz22SWU/bUBCF/fdbxE+o6GNb9YG2aqmgDVkgFIPjLI5tSEIWx8F7DCE0xMRfh1RQVDHS0Zy5unNmuVcZjx08z8edXBKEIZ7vEwYhy2XGg+U5PJGnQOhqtY5X4p9DaXccun2XkdNjPLoQsYD+yCFMpvhRhCcIhMfpFdF0KkUjojhhfntLHMcs7+/JBGufZSJod9nf28M2mvzUvlL5vMX58QmNUplmpcLRzg4Xuo5WKKCXK3jDIRPHIfEDfM8jlQbSBy+TpVJA0Wsa+u4u1vcSb9RXlH+8JTBs5q5LUm8QqicsJCm0z7jqdrkTnrcMMhFfNZpklk1mSKyqZCKsmHJgdTqcdS84dVWi2YwDETGHA0ytRuvwkPPRiHqrRW8wWI/30k4fTdElSS/sUy8UaQ/bTCYuZvWImYiEeoNJ22S+WKx3a1kWoXRBTSeXO7nk5qZJbrTJj1XymxuUpq7RPKigl4o4kz5p5BNXSmTtFuloQOA63C1+E8oPuL6+ltdf/m2Ql0050AyqH75Q3XrHYfOMuj2m962MoXc4dVJ+WWP8ZEYsr50kyT/Bx5H/g/JR89jZPqa4XWVjr8fmJ5ut9xobu2M2ix6vCx5qf8psGhO/JPh8n4I/6KeUJkLINvgAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"2\"\n        title=\"2\"\n        src=\"/static/0d81e2a29caeaef1d92ba1009cadad88/fcda8/2.png\"\n        srcset=\"/static/0d81e2a29caeaef1d92ba1009cadad88/12f09/2.png 148w,\n/static/0d81e2a29caeaef1d92ba1009cadad88/e4a3f/2.png 295w,\n/static/0d81e2a29caeaef1d92ba1009cadad88/fcda8/2.png 590w,\n/static/0d81e2a29caeaef1d92ba1009cadad88/efc66/2.png 885w,\n/static/0d81e2a29caeaef1d92ba1009cadad88/09e48/2.png 974w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Normally Luke would group the same functions together but since I don’t have debugging symbols I had to eyeball nearby addresses to guess if it’s the same place. And what do we see? Not one bottleneck but two of them!</p>\n<h2 id=\"down-the-rabbit-hole\" style=\"position:relative;\"><a href=\"#down-the-rabbit-hole\" aria-label=\"down the rabbit hole permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Down the rabbit hole</h2>\n<p>Having borrowed my friend’s completely legitimate copy of the industry-standard disassembler (no, I really can’t afford the thing… gonna learn to ghidra one of these days) I went to take GTA apart.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/152ffab8f17ce02bb6b6ec3ae60eeb74/7e11a/3.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 39.189189189189186%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABbUlEQVQoz3VSy3LCMAzM19Da8duO45QwEFI4cOXM/3/GdmV66kwPG2liebVaeZjnipJHfM0aMY4IScNHA2MsjLXwwSPlwLOAlCKmKTH38N6xxsBKjfdwzvV8EMK5KBybQooaISuEoDGOhmADEk5T7kS1vhGCI4llg4R1XXG5XDpKKRhqrWQ20HrsP5ZlwZQTFqppvLgmizlbROYhBJ43fB2POJ1O2Pcdr9cL5/MZ27ax6YRBPiJV1Eguh7ktaLxUhHQasTbNXNRG7NcrKuuEXEaWeDgcOpRSGFqrndAa8SvizPFuVLUnh1N0uNKvb+KWPBaqrHZENWxCq7btivv9jufzicfjgdba20PnLII3b9Nz7spKyYg0OtGrHAyylxoZ/beWTcQiIREfBWIBCSduWOFy/ECrHjFHbjn2rY0cyXmOymVJjHwBuXyyseKmFUfW9F73USWKBV1hLRpLZTGfT8zm14J37M/nH/S6P/gBdYv+QhYXKJEAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"3\"\n        title=\"3\"\n        src=\"/static/152ffab8f17ce02bb6b6ec3ae60eeb74/fcda8/3.png\"\n        srcset=\"/static/152ffab8f17ce02bb6b6ec3ae60eeb74/12f09/3.png 148w,\n/static/152ffab8f17ce02bb6b6ec3ae60eeb74/e4a3f/3.png 295w,\n/static/152ffab8f17ce02bb6b6ec3ae60eeb74/fcda8/3.png 590w,\n/static/152ffab8f17ce02bb6b6ec3ae60eeb74/efc66/3.png 885w,\n/static/152ffab8f17ce02bb6b6ec3ae60eeb74/c83ae/3.png 1180w,\n/static/152ffab8f17ce02bb6b6ec3ae60eeb74/7e11a/3.png 1235w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>That doesn’t look right at all. Most high-profile games come with built-in protection against reverse engineering to keep away pirates, cheaters, and modders. Not that it has ever stopped them.</p>\n<p>There seems to be some sort of an obfuscation/encryption at play here that has replaced most instructions with gibberish. Not to worry, we simply need to dump the game’s memory while it’s executing the part we want to look at. The instructions have to be de-obfuscated before running one way or another. I had Process Dump lying around, so I used that, but there are plenty of other tools available to do this sort of thing.</p>\n<h2 id=\"problem-one-its-strlen\" style=\"position:relative;\"><a href=\"#problem-one-its-strlen\" aria-label=\"problem one its strlen permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Problem one: It’s… strlen?!</h2>\n<p>Disassembling the now-less-obfuscated dump reveals that one of the addresses has a label pulled out of somewhere! It’s strlen? Going down the call stack the next one is labeled vscan_fn and after that the labels end, tho I’m fairly confident it’s sscanf.\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/31237664924c2fda9c940a21a7abd587/c3fd4/4.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 54.05405405405405%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAACDklEQVQoz32ST2gTQRTGcxVFvAi1qKcitWfBm3jwUrSCIIIX/+FBRPAiiAdPHqwgihdBoYIXKaKComCLSJVUAzY9JLXSpEn/ZJPZJLtJNrtJmmwyP2c3MaSpOvB4M++9+d735puAaZroehYhhPI6Rt4gm8uRWlpCfJpC/zyNNvUBfX4Op16nXK1ie1YsYufz2KUStm13LUD/ktJ3leAM0YFt/Ni/i7mdAbRrl1SwhozFkKq5jC8jZ74gFQnpX5O+Beg59FpLVblli+i3Wax0ilajgXdTui40m/yLyFbATnHpzSTa5bMsXjlP4uoF9Ns3aBYKKlFCamnk6ioyPK+YxpGJZJdlF7DbyGOglvFwnOTQbkIH9/JzeJD08SO4IoN6YGStBuodMQzVwGrvOyy3AnYSdeUcZZG1dUzlq39yPf5vY28C9Ed2G/6+8Oge6yODLBweYfnQATJjR9sMhRLBGz2jhAnOQigESvEtgL71tC+9fkn89CjRi2cInzyGuHkdWbaV0oqr4+BXS/l/hl6g5phULcFG08F0bVoqLAoGuaJBvWxiF3K4jY02qKYhs1lVICC5slll37dc1t6OEnu2j/DjIWITexAfb5E6N8ziiR2ETw0QH9tO+f1TsCrt0W2PdUWdrb5v00Yk/+sVieADItN3yUWeYCW+It5NkJy8T+zFOCvP72AsfO+KI/tG/g0p0SIR2p5qXwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"4\"\n        title=\"4\"\n        src=\"/static/31237664924c2fda9c940a21a7abd587/fcda8/4.png\"\n        srcset=\"/static/31237664924c2fda9c940a21a7abd587/12f09/4.png 148w,\n/static/31237664924c2fda9c940a21a7abd587/e4a3f/4.png 295w,\n/static/31237664924c2fda9c940a21a7abd587/fcda8/4.png 590w,\n/static/31237664924c2fda9c940a21a7abd587/c3fd4/4.png 854w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\nIt’s parsing something. Parsing what? Untangling the disassembly would take forever so I decided to dump some samples from the running process using x64dbg. Some debug-stepping later it turns out it’s… JSON! They’re parsing JSON. A whopping 10 megabytes worth of JSON with some 63k item entries.</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"key\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"WP_WCT_TINT_21_t2_v9_n2\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"price\"</span><span class=\"token operator\">:</span> <span class=\"token number\">45000</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"statName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"CHAR_KIT_FM_PURCHASE20\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"storageType\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"BITFIELD\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"bitShift\"</span><span class=\"token operator\">:</span> <span class=\"token number\">7</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"bitSize\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"category\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"CATEGORY_WEAPON_MOD\"</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></code></pre></div>\n<p>What is it? It appears to be data for a “net shop catalog” according to some references. I assume it contains a list of all the possible items and upgrades you can buy in GTA Online.</p>\n<p>Clearing up some confusion: I beleive these are in-game money purchasable items, not directly linked with microtransactions.</p>\n<p>But 10 megs? That’s nothing! And using sscanf may not be optimal but surely it’s not that bad? Well…</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4d86cf34641645e7dc1cdbe09bdba9cd/c1b63/5.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 46.621621621621614%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABRElEQVQoz32S527CQBCE8/5PFloKKIDBNiVgihAdgzHclx2bkh9ORhp5dVrP7cztC84huCgCzyONJsRBQDIccrKzZDRi3+sTT2ecrdZ5ejxCHOPWG+MalkvuOi8qsnK75brZsD2faXY7eGFA24RDY79aJWy18Op1vrw2S+u7GDE6ic3m5FO5XPCOZ/ULqxWEPUhT2O/BpmW3K+7NBAVrdGoMQlzXxw0GOW1q9z2yvtxFxvEY5/tg0bi+9UymYHFwOt0sC4MhlCvQaIDZolIF+zGbTnndbud6hcMB5mbRD2CxyKZVXCTJM8MHmq3c2h92HtBUN4Fiy7pZ1ETjKK8lLNojZT9LRJN/fEKtljt6LcHbe14r34dlCSgHe1GtTsZO19gByzCLRA9TKj/FylbbCqF1U/6XS4Hl/6B9U3bKTV+5KbD8A3tHtPJLfogiAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"5\"\n        title=\"5\"\n        src=\"/static/4d86cf34641645e7dc1cdbe09bdba9cd/fcda8/5.png\"\n        srcset=\"/static/4d86cf34641645e7dc1cdbe09bdba9cd/12f09/5.png 148w,\n/static/4d86cf34641645e7dc1cdbe09bdba9cd/e4a3f/5.png 295w,\n/static/4d86cf34641645e7dc1cdbe09bdba9cd/fcda8/5.png 590w,\n/static/4d86cf34641645e7dc1cdbe09bdba9cd/efc66/5.png 885w,\n/static/4d86cf34641645e7dc1cdbe09bdba9cd/c83ae/5.png 1180w,\n/static/4d86cf34641645e7dc1cdbe09bdba9cd/c1b63/5.png 1200w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Yeah, that’s gonna take a while… To be fair I had no idea most sscanf implementations called strlen so I can’t blame the developer who wrote this. I would assume it just scanned byte by byte and could stop on a NULL.</p>\n<h2 id=\"problem-two-lets-use-a-hash---array\" style=\"position:relative;\"><a href=\"#problem-two-lets-use-a-hash---array\" aria-label=\"problem two lets use a hash   array permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Problem two: Let’s use a Hash- … Array?</h2>\n<p>Turns out the second offender is called right next to the first one. They’re both even called in the same if statement as seen in this ugly decompilation:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a90fd130174f07cb79682ab13d2acbf0/baa75/6.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 16.89189189189189%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsTAAALEwEAmpwYAAAApklEQVQI1x2PV27EMAwFfR03WVr1ZiAyEmCR+59nltoPgvUNycWGQG+WmhQ5akrc6eWkZkMqjpdXKKdJ3lN6w9RK8I4ePU6d+EthzgNjDGMMliNGzN8vrSZaUfgauXPA6IvxPPT7ppTC//vNM35krlJbw1rLtm3s+866rjjnqNJblACVCKZpuURpLTDNeRxf0QTknL/QJD7K/MyDfDbjWZ+wJkvmhR9DhmIwKZemnAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"6\"\n        title=\"6\"\n        src=\"/static/a90fd130174f07cb79682ab13d2acbf0/fcda8/6.png\"\n        srcset=\"/static/a90fd130174f07cb79682ab13d2acbf0/12f09/6.png 148w,\n/static/a90fd130174f07cb79682ab13d2acbf0/e4a3f/6.png 295w,\n/static/a90fd130174f07cb79682ab13d2acbf0/fcda8/6.png 590w,\n/static/a90fd130174f07cb79682ab13d2acbf0/efc66/6.png 885w,\n/static/a90fd130174f07cb79682ab13d2acbf0/c83ae/6.png 1180w,\n/static/a90fd130174f07cb79682ab13d2acbf0/baa75/6.png 1746w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>All labels are mine, no idea what the functions/parameters are actually called.</p>\n<p>The second problem? Right after parsing an item, it’s stored in an array (or an inlined C++ list? not sure). Each entry looks something like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">struct</span> <span class=\"token punctuation\">{</span>\n    uint64_t <span class=\"token operator\">*</span>hash<span class=\"token punctuation\">;</span>\n    item_t   <span class=\"token operator\">*</span>item<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> entry<span class=\"token punctuation\">;</span></code></pre></div>\n<p>But before it’s stored? It checks the entire array, one by one, comparing the hash of the item to see if it’s in the list or not. With ~63k entries that’s (n^2+n)/2 = (63000^2+63000)/2 = 1984531500 checks if my math is right. Most of them useless. You have unique hashes why not use a hash map.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/55cd41a464853be01bbc8959c349b06c/5148a/7.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 63.51351351351351%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAACR0lEQVQ4y3VTWXbbMBDTaRptpLho323Llpf++ABOcv9LoBg5Tl/72o95pDgiZoABg7KukZUl+i5F2yikXYu0rBB6j8Oy4LLsMbcNlmlA4x3WecS6mzHzv7ppMAw9xnHENE2oqgqBdg6KB+k4o5089vsB/fmMUcC4LscjjLVbVCz+eP9gvOPj8xOPxwPv3N/v9w20Zj5QxsByo8cB4biDsh6ZUjBaI01TFEWxVY+iaPvOsgyaOVkdm9Ff/0k+jmN2yIOc9HRewDuNrniDLQ3eup7UC0RhiMPhsMUwDLhcLltHt9sN67rier3idDrBsDEBDtIkgWGHDZPWWTibwFp24AwUCyUs6PN8A3t1+App5hWSU2QWKAKKhiE1s5lC4SNYk8JnIRICxSzWEUw0ElpySS7/KzZAqdTIpDmxeL+Ho2Yi7nOCA3a7Hbqu+6Ykl/4XG2XZ+Nxj5kRNVaJr2238JfWz1iAhAxFb1t+dvIIgfwNWBJnnGUVecQAxL4tOYpEGeV7SNivj9FyXldQngiskKSMh6B+FSHldz5inHqX7gdwlqMsM51OPaSgwdA59a9DWhvtnSF509jaE9woRB2fFp99TptAJX4FbelgVMZFyOBEyzX0Ww5nnas1zn+kYTWUJXlJrWq1p0VBv0V2mHWi2qeWjqKBYQWtSIWWlxA4pbZNtVOQ8Vhm7yum9n7hcxYdnnGm3I1+T+DGnK4K6rrCfOlLJUeaK2mlE/QDjSbWkTaixUGsr6kRdK3YjBUIaXoYVRfHX+nxJvwDTeaTXIBfxLwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"7\"\n        title=\"7\"\n        src=\"/static/55cd41a464853be01bbc8959c349b06c/fcda8/7.png\"\n        srcset=\"/static/55cd41a464853be01bbc8959c349b06c/12f09/7.png 148w,\n/static/55cd41a464853be01bbc8959c349b06c/e4a3f/7.png 295w,\n/static/55cd41a464853be01bbc8959c349b06c/fcda8/7.png 590w,\n/static/55cd41a464853be01bbc8959c349b06c/efc66/7.png 885w,\n/static/55cd41a464853be01bbc8959c349b06c/c83ae/7.png 1180w,\n/static/55cd41a464853be01bbc8959c349b06c/5148a/7.png 1228w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>I named it hashmap while reversing but it’s clearly not<em>a</em>hashmap. And it gets even better. The hash-array-list-thing is empty before loading the JSON. And all of the items in the JSON are unique! They don’t even need to check if it’s in the list or not! They even have a function to directly insert the items! Just use that! Srsly, WAT!?</p>\n<h2 id=\"poc\" style=\"position:relative;\"><a href=\"#poc\" aria-label=\"poc permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>PoC</h2>\n<p>Now that’s nice and all, but no one is going to take me seriously unless I test this so I can write a clickbait title for the post.</p>\n<p>The plan? Write a .dll, inject it in GTA, hook some functions, ???, profit.</p>\n<p>The JSON problem is hairy, I can’t realistically replace their parser. Replacing sscanf with one that doesn’t depend on strlen would be more realistic. But there’s an even easier way.</p>\n<ul>\n<li>hook strlen</li>\n<li>wait for a long string</li>\n<li>“cache” the start and length of it</li>\n<li>if it’s called again within the string’s range, return cached value</li>\n</ul>\n<p>Something like:</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">size_t <span class=\"token function\">strlen_cacher</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span><span class=\"token operator\">*</span> str<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">static</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> start<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">static</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> end<span class=\"token punctuation\">;</span>\n  size_t len<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> size_t cap <span class=\"token operator\">=</span> <span class=\"token number\">20000</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// if we have a \"cached\" string and current pointer is within it</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>start <span class=\"token operator\">&amp;&amp;</span> str <span class=\"token operator\">>=</span> start <span class=\"token operator\">&amp;&amp;</span> str <span class=\"token operator\">&lt;=</span> end<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// calculate the new strlen</span>\n    len <span class=\"token operator\">=</span> end <span class=\"token operator\">-</span> str<span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// if we're near the end, unload self</span>\n    <span class=\"token comment\">// we don't want to mess something else up</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>len <span class=\"token operator\">&lt;</span> cap <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n      <span class=\"token function\">MH_DisableHook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>LPVOID<span class=\"token punctuation\">)</span>strlen_addr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// super-fast return!</span>\n    <span class=\"token keyword\">return</span> len<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// count the actual length</span>\n  <span class=\"token comment\">// we need at least one measurement of the large JSON</span>\n  <span class=\"token comment\">// or normal strlen for other strings</span>\n  len <span class=\"token operator\">=</span> <span class=\"token function\">builtin_strlen</span><span class=\"token punctuation\">(</span>str<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// if it was the really long string</span>\n  <span class=\"token comment\">// save it's start and end addresses</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>len <span class=\"token operator\">></span> cap<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    start <span class=\"token operator\">=</span> str<span class=\"token punctuation\">;</span>\n    end <span class=\"token operator\">=</span> str <span class=\"token operator\">+</span> len<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// slow, boring return</span>\n  <span class=\"token keyword\">return</span> len<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>And as for the hash-array problem, it’s more straightforward - just skip the duplicate checks entirely and insert the items directly since we know the values are unique.</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">char</span> __fastcall <span class=\"token function\">netcat_insert_dedupe_hooked</span><span class=\"token punctuation\">(</span>uint64_t catalog<span class=\"token punctuation\">,</span> uint64_t<span class=\"token operator\">*</span> key<span class=\"token punctuation\">,</span> uint64_t<span class=\"token operator\">*</span> item<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// didn't bother reversing the structure</span>\n  uint64_t not_a_hashmap <span class=\"token operator\">=</span> catalog <span class=\"token operator\">+</span> <span class=\"token number\">88</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// no idea what this does, but repeat what the original did</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token function\">uint8_t</span><span class=\"token punctuation\">(</span>__fastcall<span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>uint64_t<span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>item <span class=\"token operator\">+</span> <span class=\"token number\">48</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// insert directly</span>\n  <span class=\"token function\">netcat_insert_direct</span><span class=\"token punctuation\">(</span>not_a_hashmap<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// remove hooks when the last item's hash is hit</span>\n  <span class=\"token comment\">// and unload the .dll, we are done here :)</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>key <span class=\"token operator\">==</span> <span class=\"token number\">0x7FFFD6BE</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">MH_DisableHook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>LPVOID<span class=\"token punctuation\">)</span>netcat_insert_dedupe_addr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">unload</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"results\" style=\"position:relative;\"><a href=\"#results\" aria-label=\"results permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Results</h2>\n<p>Well, did it work then?</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">Original online mode load time:        ~6m flat\nTime with only duplication check patch: 4m 30s\nTime with only JSON parser patch:       2m 50s\nTime with both issues patched:          1m 50s\n\n(6*60 - (1*60+50)) / (6*60) = 69.4% load time improvement (nice!)</code></pre></div>\n<p>Hell yes, it did! :))</p>\n<p>Most likely, this won’t solve everyone’s load times - there might be other bottlenecks on different systems, but it’s such a gaping hole that I have no idea how R* has missed it all these years.</p>\n<h2 id=\"tldr\" style=\"position:relative;\"><a href=\"#tldr\" aria-label=\"tldr permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>tl;dr</h2>\n<ul>\n<li>There’s a single thread CPU bottleneck while starting up GTA Online</li>\n<li>It turns out GTA struggles to parse a 10MB JSON file</li>\n<li>The JSON parser itself is poorly built / naive and</li>\n<li>After parsing there’s a slow item de-duplication routine</li>\n</ul>\n<h2 id=\"r-please-fix\" style=\"position:relative;\"><a href=\"#r-please-fix\" aria-label=\"r please fix permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>R* please fix</h2>\n<p>If this somehow reaches Rockstar: the problems shouldn’t take more than a day for a single dev to solve. Please do something about it :&#x3C;</p>\n<p>You could either switch to a hashmap for the de-duplication or completely skip it on startup as a faster fix. For the JSON parser - just swap out the library for a more performant one. I don’t think there’s any easier way out.</p>\n<p>ty &#x3C;3</p>\n<h2 id=\"small-update\" style=\"position:relative;\"><a href=\"#small-update\" aria-label=\"small update permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Small update</h2>\n<p>I was expecting to get some attention but nowhere near this much! After reaching the top of HN this post has spread like wildfire! Thank you for the overwhelming response :)</p>\n<p>I’ll do more writing if something interesting comes along, but don’t expect anything of this scale soon - there was a lot of luck involved.</p>\n<p>A few people suggested spamming this post to Rockstar’s support - please don’t! I’m sure they’ve seen this by now. Continuing would only bog down support tickets for everyone else. Social media is fair game in my book tho.</p>\n<p>Several HN comments suggested I add a donate button, as they would like to buy me a beer (thank you!) so I’m placing a link in the footer.</p>\n<p>Thank you for reading and all the support :)</p>","excerpt":"原文链接 GTA Online. Infamous for its slow loading times. Having picked up the game again to finish some of the newer heists I was shocked (/s…","frontmatter":{"title":"How I cut GTA Online loading times by 70%","date":"02.03.2021","category":"Game"},"timeToRead":10}},"pageContext":{"slug":"/how-i-cut-gta-online-loading-times-by-70","prev":{"fileAbsolutePath":"/Users/owenwang/Documents/javascript/serializedowen.github.io/blog/typescript-magic.md","fields":{"slug":"/浅入浅出-type-script-泛型与类型黑魔法"},"sourceType":"posts","frontmatter":{"title":"浅入浅出 TypeScript 泛型与类型黑魔法","category":"TypeScript"}},"next":null}},"staticQueryHashes":["1124436713","4274079806"]}